# 带你模拟真实的分布式项目生产演练

## 回顾上节课内容

ElasticSearch如何进行全文检索

​	中文分词：ik_max_word，ik_smart

​	搜索自动建议：suggest

​	百度地图：百度坐标地址结合ElasticSearch geo_point类型

## 本节课的内容

### ES优化技巧

#### 索引结构调

```json
PUT /renting
{
  "settings": {
    "number_of_replicas": 0,	// 生产环境，1。开发环境，0。
    "number_of_shards": 5,  // 一个集群，5个分片
    "index.store.type": "niofs", // nio对应的文件系统，效率性能更高
    "index.query.default_field": "", // 
    "index.unassigned.node_left.delayed_timeout": "5m"
  },
  "mappings":{
    "house":{
       "dynamic": "strict", // 索引结构固定了，严谨模式性能更好
       // 6.0+版本作废，采用copy_to实现。将所有其他字段的值作为一个大字符串索引的，这么做并不十分灵活。
       "_all":{
         "enabled":false
       },
       // 不存储原始值，只保留索引。一个文档几KB，在大数据量的情况可以节省空间
       "_source":{
           "enabled":false
       },
       "properties": {
          ......
           	id:
            房屋介绍:
            周边服务:
            配套服务:
       }
    }
  }
}
```

#### 使用模板

在数据量非常大的情况。一个索引建议最大20G，要去进行索引拆分。

按照，城市、行政区来进行拆分，在某些业务里，可以按照时间、用户

es_renting_sh、es_renting_bj、es_renting_sz

```json
PUT _template/es_renting_template
{
    "template": "es_renting_log_*"	// es_renting_bj，es_renting_sh，es_renting_sz
    ......
    "aliases": {// 别名，取别名的好处在于真实的名字可以随意调整，而程序不用变动，比如reindex的操作
  		"renting": {}
  	}
}
```



### 项目首次上线

#### 打包

pom文件打包

各环境配置文件拆分

日志处理

环境

​	联调环境、生产环境

### 故障演练

#### 单点故障

Nginx解决web服务故障的问题

Nginx带来的服务雪崩问题，限流限速

#### Dubbo服务故障

服务治理，DubboAdmin

​	禁用隔离不可用的服务



### 版本迭代

程序问题，修复bug，发布一个新的版本

迭代的过程，怎么保证服务可用？

逐一升级，DubboAdmin来禁用服务进行控制

正在执行的请求，怎么处理？

shutHook，Dubbo优雅停机

